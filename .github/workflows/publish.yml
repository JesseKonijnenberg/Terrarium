name: Publish Release

on:
  push:
    tags:
      - 'v*'
permissions:
  contents: write
  
jobs:
  build_and_publish:
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest]
    
    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x' # Keep this matching your project

    - name: Install Velopack Tool
      run: dotnet tool install -g vpk

    # --- WINDOWS BUILD ---
    - name: Build & Pack (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        # 1. Clean the version number (Remove 'v' from 'v1.0.0')
        $ver = $env:GITHUB_REF_NAME.TrimStart('v')
        Write-Host "Building Version: $ver"

        # 2. Publish (Explicit project path)
        dotnet publish ./Terrarium.Avalonia/Terrarium.Avalonia.csproj -c Release -r win-x64 --self-contained -o ./publish
        
        # 3. Pack (Using the clean $ver variable)
        vpk pack -u Terrarium -v $ver -p ./publish -e Terrarium.Avalonia.exe

    # --- LINUX BUILD ---
    - name: Build & Pack (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get install -y libfuse2
        
        # 1. Clean the version number (Bash syntax to strip 'v')
        VERSION=${GITHUB_REF_NAME#v}
        echo "Building Version: $VERSION"

        # 2. Publish (Explicit project path)
        dotnet publish ./Terrarium.Avalonia/Terrarium.Avalonia.csproj -c Release -r linux-x64 --self-contained -o ./publish
        
        # 3. Pack (Using the clean $VERSION variable)
        vpk pack -u Terrarium -v $VERSION -p ./publish -e Terrarium.Avalonia

    - name: Upload Release to GitHub
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          Releases/*

name: Publish Release

on:
  push:
    tags:
      - 'v*'
permissions:
  contents: write
  
jobs:
  build_and_publish:
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest]
    
    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Install Velopack Tool
      run: dotnet tool install -g vpk

    # --- WINDOWS BUILD ---
    - name: Build & Pack (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        # 1. Clean the version number
        $ver = $env:GITHUB_REF_NAME.TrimStart('v')
        Write-Host "Building Version: $ver"

        # 2. Publish (FIXED: Using $ver instead of $VERSION)
        dotnet publish ./Terrarium.Avalonia/Terrarium.Avalonia.csproj -c Release -r win-x64 --self-contained -p:Version=$ver -o ./publish
        
        # 3. Pack
        vpk pack -u Terrarium -v $ver -p ./publish -e Terrarium.Avalonia.exe -i ./Terrarium.Avalonia/Assets/logo.ico

    # --- LINUX BUILD ---
    - name: Build & Pack (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get install -y libfuse2
        
        # 1. Clean the version number
        VERSION=${GITHUB_REF_NAME#v}
        echo "Building Version: $VERSION"

        # 2. Publish (Linux uses Bash, so $VERSION is correct here)
        dotnet publish ./Terrarium.Avalonia/Terrarium.Avalonia.csproj -c Release -r linux-x64 --self-contained -p:Version=$VERSION -o ./publish
        
        # 3. Pack
        vpk pack -u Terrarium -v $VERSION -p ./publish -e Terrarium.Avalonia -i ./Terrarium.Avalonia/Assets/logo.png

    - name: Upload Release to GitHub
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          Releases/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

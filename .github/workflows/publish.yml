name: Publish Release

on:
  push:
    tags:
      - 'v*' # Triggers when you push a tag like v1.0.0

jobs:
  build_and_publish:
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest]
    
    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x' # Use 8.0 or 9.0 depending on your project

    - name: Install Velopack Tool
      run: dotnet tool install -g vpk

    - name: Build & Pack (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        dotnet publish -c Release -r win-x64 --self-contained -o ./publish
        vpk pack -u Terrarium -v ${{ github.ref_name }} -p ./publish -e Terrarium.Avalonia.exe

    - name: Build & Pack (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        # Install Fuse (needed for AppImage creation)
        sudo apt-get install -y libfuse2
        
        dotnet publish -c Release -r linux-x64 --self-contained -o ./publish
        # Note: 'vpk' creates an AppImage automatically on Linux
        vpk pack -u Terrarium -v ${{ github.ref_name }} -p ./publish -e Terrarium.Avalonia

    - name: Upload Release to GitHub
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          Releases/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: Publish Release

on:
  push:
    tags:
      - 'v*' # Triggers when you push a tag like v1.0.0

jobs:
  build_and_publish:
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest]
    
    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x' # Ensure this matches your project (e.g. 10.0.x if you are on preview)

    - name: Install Velopack Tool
      run: dotnet tool install -g vpk

    # --- WINDOWS BUILD ---
    - name: Build & Pack (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        # 1. Point explicitly to the Avalonia project (Not the solution!)
        dotnet publish ./Terrarium.Avalonia/Terrarium.Avalonia.csproj -c Release -r win-x64 --self-contained -o ./publish
        
        # 2. Pack it
        vpk pack -u Terrarium -v ${{ github.ref_name }} -p ./publish -e Terrarium.Avalonia.exe

    # --- LINUX BUILD ---
    - name: Build & Pack (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get install -y libfuse2
        
        # 1. Point explicitly to the Avalonia project here too
        dotnet publish ./Terrarium.Avalonia/Terrarium.Avalonia.csproj -c Release -r linux-x64 --self-contained -o ./publish
        
        vpk pack -u Terrarium -v ${{ github.ref_name }} -p ./publish -e Terrarium.Avalonia

    - name: Upload Release to GitHub
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          Releases/*
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
